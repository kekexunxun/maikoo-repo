<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.maikoo.businessdirectory.dao.SchoolGroupDao">
    <resultMap id="schoolGroupResultMap" type="SchoolGroupDO">
        <result property="groupId" column="group_id"/>
        <result property="groupName" column="group_name"/>
        <result property="groupAvatarUrl" column="group_avatar_url"/>
        <result property="groupAddrCode" column="group_addr_code"/>
        <result property="groupBrief" column="group_brief"/>
        <result property="groupAddrDetail" column="group_addr_detail"/>
        <result property="schoolName" column="school_name"/>
        <result property="posterUrl" column="poster_url"/>
        <result property="qrCodeUrl" column="qr_code_url"/>
        <result property="isEnable" column="is_enable"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="dismissedAt" column="dismissed_at"/>
        <result property="groupMemCount" column="group_mem_count"></result>

        <association property="userDO" resultMap="com.maikoo.businessdirectory.dao.UserDao.userResultMap" columnPrefix="user_"></association>
    </resultMap>

    <select id="selectIdsByKeyAndUserId" resultType="java.lang.Long">
        SELECT
            sg.group_id
        FROM
            gr_school_group sg
            JOIN grtu_school_user su ON sg.group_id = su.group_id
        WHERE
            su.status = 1
            AND su.user_id = #{userId}
            <if test="key != null">
                AND sg.group_name LIKE CONCAT('%',#{key},'%')
            </if>
    </select>

    <select id="selectByIds" resultMap="schoolGroupResultMap">
        SELECT
            sg.group_id,
            sg.group_name,
            sg.group_avatar_url,
            sg.group_addr_detail,
            COUNT(su.idx) AS group_mem_count
        FROM
            gr_school_group sg
            JOIN grtu_school_user su ON sg.group_id = su.group_id
        WHERE
            sg.group_id IN
            <foreach item="id" index="index" collection="ids"
                     open="(" separator="," close=")">
                #{id}
            </foreach>
        GROUP BY sg.group_id
    </select>

    <select id="analysisGroupData" parameterType="com.maikoo.businessdirectory.model.TimeFrequentQuery" resultType="integer">
            select count(*) from gr_school_group where created_at<![CDATA[>= ]]>#{startTime} and created_at<![CDATA[<= ]]> #{endTime}
    </select>

    <select id="analysisGroupUserData" parameterType="com.maikoo.businessdirectory.model.TimeFrequentQuery" resultType="integer">
            select count(*) from grtu_school_user where joined_at<![CDATA[>= ]]>#{startTime} and joined_at<![CDATA[<= ]]> #{endTime}
    </select>

    <select id="selectAll" resultMap="schoolGroupResultMap">
        SELECT
            sg.group_id,
            sg.group_name,
            sg.group_avatar_url,
            sg.group_addr_code,
            sg.group_addr_detail,
            sg.group_brief,
            sg.school_name,
            sg.is_enable,
            sg.created_at,
            sg.dismissed_at,
            COUNT(su.idx) AS group_mem_count
        FROM
            gr_school_group sg
            JOIN grtu_school_user su ON sg.group_id = su.group_id
        GROUP BY sg.group_id
    </select>
</mapper>