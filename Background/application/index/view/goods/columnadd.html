<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="renderer" content="webkit|ie-comp|ie-stand" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <!--[if lt IE 9]>
        <script type="text/javascript" src="__ROOT__/public/static/lib/html5shiv.js"></script>
        <script type="text/javascript" src="__ROOT__/public/static/lib/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="__ROOT__/static/lib/h-ui/css/H-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="__ROOT__/static/lib/h-ui.admin/css/H-ui.admin.css" />
    <link rel="stylesheet" type="text/css" href="__ROOT__/static/lib/Hui-iconfont/1.0.8/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="__ROOT__/static/lib/h-ui.admin/skin/default/skin.css" id="skin" />
    <link rel="stylesheet" type="text/css" href="__ROOT__/static/lib/h-ui.admin/css/style.css" />
    <link rel="stylesheet" href="__ROOT__/static/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css" type="text/css">
    <link href="__ROOT__/static/lib/jqueryColorPicker/css/colorpicker.css" rel="stylesheet" type="text/css" />
    <style>
        .colorSpan{
            display:inline-block;
            width:25px;
            height:25px;
            background-color:#FFFFFF;
            border:1px solid gray;
        }
        .fileupload .thumbnail {
            overflow: hidden;
            display: inline-block;
            margin-bottom: 5px;
            vertical-align: middle;
            text-align: center;
        }
        .thumbnail {
            display: block;
            padding: 4px;
            margin-bottom: 20px;
            line-height: 1.42857143;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            -webkit-transition: all .2s ease-in-out;
            transition: all .2s ease-in-out;
        }
        .fileupload-preview {
            width: 200px;
            height: 150px;
            display: block;
            color: #666;
        }
        .fileupload-preview img{
            margin-bottom:15px;
            width:100%;
            height:100%;
        }
        .fileupload-exists .fileupload-new, .fileupload-new .fileupload-exists {
            display: none;
        }
        .fileupload .btn {
            vertical-align: middle;
            line-height: 18px;
            margin-left: 0px;
        }
        .btn-file {
            overflow: hidden;
            position: relative;
            vertical-align: middle;
        }
        .fa {
            display: inline-block;
            font-family: FontAwesome;
            font-style: normal;
            font-weight: normal;
            line-height: 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .btn-file>input{
            position: absolute;
            top: 0;
            right: 0;
            margin: 0;
            opacity: 0;
            filter: alpha(opacity=0);
            transform: translate(-300px, 0) scale(4);
            font-size: 23px;
            direction: ltr;
            cursor: pointer;
        }
        .btn {
            display: inline-block;
            margin-bottom: 0;
            font-weight: 400;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background-image: none;
            border: 1px solid transparent;
            white-space: nowrap;
            padding: 6px 12px;
            font-size: 14px;
            line-height: 1.42857143;
            border-radius: 4px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
    <title>添加专栏界面</title>
</head>

<body>
    <div class="page-container">
        <form action="/" method="post" class="form form-horizontal" id="form-column-add">
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">专栏名称：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <input type="text" style="width: 200px;" maxlength="25" class="input-text" value="" placeholder="专栏名称"
                        id="column_name" name="column_name" autocomplete="off" />
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">排序：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <input type="text" style="width: 200px;" maxlength="4" class="input-text" value="" placeholder="排序"
                        id="sort" name="sort" autocomplete="off" />
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">专栏主题颜色：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <span class="colorSpan" id="choiceColor"></span>
                    <input type="text" style="width: 200px;" maxlength="6" class="input-text" value="" placeholder="专栏颜色"
                        id="column_color" name="column_color" autocomplete="off" />
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3"></label>
                <div class="formControls col-xs-8 col-sm-9">
                    <span style="color:gray;">*封面图片只接收jpg、png格式,大小限制在2M以内.</span>
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">专栏封面：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <div class="fileupload fileupload-new add_margin" data-provides="fileupload" style="width: 34%;float: left;">
                        <div class="fileupload-new thumbnail" style="width: 200px; height: 150px;">
                            <img src="" alt="" style="width:100%;height:100%;" />
                        </div>
                        <div id="newimg_div" class="fileupload-preview fileupload-exists thumbnail"></div>
                        <div style="width:197px;">
                            <span class="btn btn-default btn-file">
                                <span class="fileupload-new"><i class="fa fa-paper-clip"></i>选择图片</span>
                                <span class="fileupload-exists"><i class="fa fa-undo"></i> 更换</span>
                                <input type="file" onchange="validateImg(this,'专栏封面',1048576*2,'newimg_div')" id="column_img"
                                    class="default" name="column_img" value="" />
                            </span>
                            <a href="#" class="btn btn-danger fileupload-exists" data-dismiss="fileupload">
                                <i class="fa fa-trash"></i>
                                清除
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row cl" id="skip">
                <label class="form-label col-xs-4 col-sm-3">展示：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <span class="select-box" id="select-span" style="width:150px;">
                        <select class="select" name="status" size="1">
                            <option value="0">
                                不展示
                            </option>
                            <option value="1">
                                展示在首页
                            </option>
                            <option value="2">
                                展示在会员页
                            </option>
                        </select>
                    </span>
                </div>
            </div>
            <div class="row cl">
                <label class="form-label col-xs-4 col-sm-3">选择商品：</label>
                <div class="formControls col-xs-8 col-sm-9">
                    <input style="width: 200px;" value="点击选择" type="button" class="input-text valid" id="selectGoods">
                </div>
            </div>
            <div class="row cl">
                <div class="col-xs-8 col-xs-offset-4 col-sm-9 col-sm-offset-3">
                    <button class="btn btn-success radius" type="submit">
                        &nbsp;&nbsp;提交&nbsp;&nbsp;
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div id="modal-demo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content radius">
                <div class="modal-header">
                    <h3 class="modal-title">商品选择</h3>
                    <a class="close" data-dismiss="modal" aria-hidden="true" href="javascript:void();">×</a>
                </div>
                <div class="modal-body">
                    <!-- <p>对话框内容…</p> -->
                    <div class="zTreeDemoBackground left">
                        <ul id="treeDemo" class="ztree"></ul>
                    </div>

                </div>
                <div class="modal-footer">
                    <button id="confirm" class="btn btn-primary">确定</button>
                    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer mt-20">
        <div class="container">
            <p>Powered By 福建麦口信息科技有限公司</p>
        </div>
    </footer>
</body>

</html>
<!--_footer 作为公共模版分离出去-->
<!-- <script src="__ROOT__/static/lib/jquery/jquery.min.js" type="text/javascript"></script> -->
<script type="text/javascript" src="__ROOT__/static/lib/jquery/jquery.min.js"></script>
<script src="__ROOT__/static/lib/layer/2.4/layer.js" type="text/javascript">
</script>
<script src="__ROOT__/static/lib/h-ui/js/H-ui.min.js" type="text/javascript">
</script>
<script src="__ROOT__/static/lib/h-ui.admin/js/H-ui.admin.js" type="text/javascript">
</script>
<!--/_footer 作为公共模版分离出去-->
<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="__ROOT__/static/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
<script src="__ROOT__/static/lib/jquery.validation/1.14.0/jquery.validate.js" type="text/javascript">
</script>
<script src="__ROOT__/static/lib/jquery.validation/1.14.0/messages_zh.js" type="text/javascript">
</script>
<script src="__ROOT__/static/lib/jquery.validation/1.14.0/validate-methods.js" type="text/javascript"></script>
<script type="text/javascript" src="__ROOT__/static/lib/jqueryColorPicker/js/colorpicker.js"></script>
<script type="text/javascript" src="__ROOT__/static/lib/bootstrap-fileupload/bootstrap-fileupload.min.js"></script>
<script type="text/javascript">
    //图片大小验证
    //byte换算
    // 1042b = 1kb
    // 1048576b = 1mb
    // 1073741824b = 1gb
    // 1099511627776b = 1tb 
    function validateImg(obj, content, max, div) {
        var fileSize = $(obj)[0].files[0].size;
        console.log(fileSize);
        if (fileSize > max) {
            $(obj).val('');
            $('#' + div + ' img').remove();
            layer.alert(content + '文件大小超出最大限制!', { icon: 2 });
        }
    }
    // zTree插件
    var setting = {
        check: {
            enable: true
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "pId",
                rootPId: 0
            }
        },
        callback: {
            beforeCheck: true,
            onCheck: onCheck
        }
    };
    var code;
    function setCheck() {
        var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
            py = $("#py").attr("checked") ? "p" : "p",
            sy = $("#sy").attr("checked") ? "s" : "s",
            pn = $("#pn").attr("checked") ? "p" : "p",
            sn = $("#sn").attr("checked") ? "s" : "s",
            type = { "Y": py + sy, "N": pn + sn };
        zTree.setting.check.chkboxType = type;
        showCode('setting.check.chkboxType = { "Y" : "' + type.Y + '", "N" : "' + type.N + '" };');
    }
    function showCode(str) {
        if (!code) code = $("#code");
        code.empty();
        code.append("<li>" + str + "</li>");
    }

    var aa = '';
    function onCheck(e, treeId, treeNode) {
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo"),
            nodes = treeObj.getCheckedNodes(true),
            v = "";
        for (var i = 0; i < nodes.length; i++) {
            v += nodes[i].id + ",";
            console.log("节点id:" + nodes[i].id + "节点名称" + v); //获取选中节点的值
        }
        aa = v;
    }

    // 点击确定保存权限
    $("#confirm").click(function () {
        if (aa) {
            $.ajax({
                type: 'POST',
                data: { goodsid: aa },
                dataType: "json",
                url: 'columnGoodsSelect',
                success: function (res) { //请求成功后处理函数。
                    if (res.code == '0') {
                        $("#modal-demo").modal("hide");
                        parent.layer.msg(res.msg, { icon: 1, time: 1000 });
                    };
                    if (res.code == '400') {
                        layer.msg(res.msg, { icon: 2, time: 1000 });
                    };
                },
                error: function (res) {
                    console.log(res);
                }
            });
        } else {
            layer.msg('您尚未选择任何商品！', { icon: 2, time: 1000 });
            return false;
        }
    })

    // 商品信息
    $('#selectGoods').click(function () {
        // 显示模态框
        $("#modal-demo").modal("show");
        $.ajax({
            async: false,
            cache: false,
            type: 'POST',
            data: {},
            dataType: "json",
            url: 'goodsData',//请求的action路径
            success: function (res) { //请求成功后处理函数
                // console.log(res);
                if (res.code == 0) {
                    treeNodes = res.data; //把后台封装好的简单Json格式赋给treeNodes
                    $.fn.zTree.init($("#treeDemo"), setting, treeNodes);
                    setCheck();
                    $("#py").bind("change", setCheck);
                    $("#sy").bind("change", setCheck);
                    $("#pn").bind("change", setCheck);
                    $("#sn").bind("change", setCheck);
                }
                if (res.code == 400) {
                    layer.msg(res.data, { icon: 2, time: 1000 });
                }
            },
            error: function (res) {
                console.log(res);
            },
        });
    })

    $(function () {
        //颜色选择
        $('#column_color').on('change', function () {
            var value = $(this).val();
            var reg = /^[0-9A-Fa-f]{6}$/;
            if (!reg.test(value)) {
                $('#column_color').val('');
            }
        });
        $('#column_color').ColorPicker({
            onSubmit: function (hsb, hex, rgb, el) {
                $(el).val(hex);
                $('#choiceColor').css({ 'background': '#' + hex });
                $(el).ColorPickerHide();
            },
            onBeforeShow: function () {
                $(this).ColorPickerSetColor(this.value);
            },
        }).bind('keyup', function () {
            $(this).ColorPickerSetColor(this.value);
        });
        //表单提交
        $("#form-column-add").validate({
            rules: {
                sort: {
                    required: true,
                    maxlength: 4,
                    digits: true,
                },
                column_name: {
                    required: true,
                    maxlength: 25,
                },
                status: {
                    required: true,
                    digits: true,
                    range: [0, 2],
                },
                column_color: {
                    required: true,
                    maxlength: 6,
                },
            },
            onkeyup: false,
            success: "valid",
            submitHandler: function (form) {
                var value = $('#column_color').val();
                var reg = /^[0-9a-fA-F]{6}$/;
                if (!reg.test(value) && value != '') {
                    layer.alert('专栏主题颜色不正确!', { icon: 2 });
                    $('#column_color').val('');
                    return;
                }
                if (value == '') {
                    $('#column_color').val('ffffff');
                    $('#choiceColor').css({ 'background': '#ffffff' });
                }
                var img = $('#column_img').val();
                if (img == '') {
                    layer.alert('请选择专栏图片');
                    return;
                } else {
                    var arr = img.split('\\');//注split可以用字符或字符串分割
                    var fileName = arr[arr.length - 1];//这就是要取得的名文件称
                    var index = fileName.lastIndexOf(".");
                    if (index < 0) {
                        layer.msg("图片格式不正确！", { icon: 6, time: 1300 });
                        return;
                    } else {
                        var ext = fileName.substring(index + 1, img.length);
                        if (ext != 'jpg' && ext != 'jpeg' && ext != 'png' && ext != 'gif') {
                            layer.msg("图片格式不正确！", { icon: 6, time: 1300 });
                            return;
                        }
                    }
                }
                layer.confirm('确定添加吗?', function () {
                    $(form).ajaxSubmit({
                        type: 'POST',
                        url: '/index/goods/columnadd',
                        typeData: 'JSON',
                        success: function (result) {
                            if (result.code < 400) {
                                layer.alert(result.msg, { icon: 1, closeBtn: 0 }, function () {
                                    window.parent.location.href = window.parent.location.href;
                                });
                            } else {
                                layer.alert(result.msg);
                            }
                        },
                        error: function () {
                            layer.alert('请求失败!');
                        }
                    });
                });
            }
        });
    });
</script>